// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Assuming PostgreSQL for robust transactions, but can be changed
  url      = env("DATABASE_URL")
}

// Custom enum for user roles
enum Role {
  ADMIN
  MANAGER
  STAFF
}

// Custom enum for inventory movement types
enum MovementType {
  RECEIPT          // Stock received from supplier
  SALE             // Stock sold to customer (handled by SaleController)
  SALE_REVERSAL    // Stock reversal due to sale deletion (handled by SaleController)
  ADJUSTMENT_IN    // Inventory count adjustment (e.g., found missing stock)
  ADJUSTMENT_OUT   // Inventory count adjustment (e.g., spoilage, lost stock)
}

// --- User Management ---
model User {
  id                  Int                    @id @default(autoincrement())
  name                String
  email               String                 @unique
  password            String // Hashed password
  role                Role                   @default(STAFF)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt

  // Relationships
  sales               Sale[]
  inventoryMovements  InventoryMovement[]
}

// --- Product Catalog ---
model Category {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  description String?
  products  Product[]
}

model Supplier {
  id        Int        @id @default(autoincrement())
  name      String     @unique
  contactEmail String?
  contactPhone String?
  products  Product[]
  movements InventoryMovement[] // Link supplier to inventory receipts
}

model Product {
  id                  Int                    @id @default(autoincrement())
  sku                 String                 @unique
  name                String                 @unique
  description         String?
  unitPrice           Float // Selling price per unit
  currentStock        Int                    @default(0) // Quantity currently on hand
  lowStockThreshold   Int                    @default(10)

  // Relationships
  categoryId          Int
  category            Category               @relation(fields: [categoryId], references: [id])
  supplierId          Int?
  supplier            Supplier?              @relation(fields: [supplierId], references: [id])

  sales               Sale[]
  inventoryMovements  InventoryMovement[]

  @@index([categoryId])
  @@index([supplierId])
  // This check constraint is advanced and sometimes requires native DB support/raw query, 
  // but it's logically correct: current stock should not exceed 10000 (a safe limit)
  @@check([currentStock >= 0])
}


// --- Sales & Transactions ---
model Sale {
  id                  Int                    @id @default(autoincrement())
  productId           Int
  quantitySold        Int
  unitPriceSold       Float
  totalSaleAmount     Float
  saleDate            DateTime               @default(now())
  notes               String?
  
  // Relationships
  product             Product                @relation(fields: [productId], references: [id])
  userId              Int
  user                User                   @relation(fields: [userId], references: [id])

  @@index([productId])
  @@index([userId])
}

// --- Inventory & Auditing ---
model InventoryMovement {
  id                  Int                    @id @default(autoincrement())
  productId           Int
  type                MovementType
  quantity            Int // Positive for IN (RECEIPT, ADJUSTMENT_IN), Negative for OUT (SALE, ADJUSTMENT_OUT)
  costPrice           Float? // Cost of the stock for receipts/adjustments (optional)
  description         String?
  timestamp           DateTime               @default(now())

  // Relationships
  product             Product                @relation(fields: [productId], references: [id])
  userId              Int
  user                User                   @relation(fields: [userId], references: [id])
  supplierId          Int?                   // Optional link for receipts
  supplier            Supplier?              @relation(fields: [supplierId], references: [id])

  @@index([productId])
  @@index([userId])
  @@index([supplierId])
}